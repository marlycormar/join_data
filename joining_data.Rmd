---
title: "Joining Data"
author: "Marly Cormar"
date: "6/25/2018"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE)

```

``` {r open_libraries}

library(openxlsx)
library(gtools)
library(plyr)

```

```{r joining_data, results='asis'}

# Set data directory
directory <- "./data/"
folders <- list.files(directory)

for(folder in folders){
  # Set up current directory
  cur_dir <- paste0(directory, folder)
  cur_dir <- paste0(cur_dir, "/")

  # Read CSV files in order
  files <- c(dir(cur_dir, full.names = FALSE, pattern = ".xlsx$"))
  files <- mixedsort(files, decreasing = TRUE)

  # Set output filename using input data filenames
  #output_file <- paste0("output/", sub("_.*$", "", files[1]))
  output_file <- paste0("output/", folder)
  output_file <- paste0(output_file, ".xlsx")

  # Change column names to reflect week number
  data <-list()
  my_sep <- "_week"
  for(i in 1:length(files)){
    data[[i]] <- read.xlsx(paste(cur_dir, files[i], sep=""))
    names(data[[i]]) <- c("USER_NAME", "UFID", "Section_No", paste("Logins", i, sep = my_sep) , paste("Hours", i, sep = my_sep), paste("PAGEVIEW", i, sep = my_sep), paste("SUBMISSION", i, sep = my_sep), paste("FILESVIEW", i, sep = my_sep), paste("CONVERSATION", i, sep = my_sep))
  }

  # Generate joined data
  output <- join_all(data, by=c("USER_NAME","UFID", "Section_No"), type='left')

  # Write joined data
  write.xlsx(output, file=output_file, sheetName="Joined forms")

}
# Print when done
cat("#### - The output has been generated")

```
